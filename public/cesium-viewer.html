<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D City Map - Shadow Simulation</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.104/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.104/Widgets/widgets.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            overflow: hidden;
        }

        #cesiumContainer {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(135deg, #001960 0%, #002d9c 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-title {
            color: white;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
        }

        .header-nav {
            display: flex;
            gap: 12px;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .control-panel {
            position: absolute;
            top: 80px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
            min-width: 240px;
            max-height: calc(100vh - 150px);
            overflow-y: auto;
        }

        .control-panel h3 {
            margin: 0 0 14px 0;
            color: #001960;
            font-size: 16px;
            font-weight: 600;
            border-bottom: 2px solid #001960;
            padding-bottom: 8px;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .section-label {
            font-weight: 600;
            color: #333;
            font-size: 13px;
            margin: 12px 0 8px 0;
            display: block;
        }

        .control-btn {
            background: linear-gradient(135deg, #001960 0%, #002d9c 100%);
            color: white;
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 25, 96, 0.25);
            text-align: left;
        }

        .control-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 25, 96, 0.35);
        }

        .control-btn:active {
            transform: translateY(0);
        }

        .control-btn.orange {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .control-btn.purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .dropdown-menu {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            background: white;
            margin-top: 8px;
        }

        .dropdown-menu:hover {
            border-color: #001960;
        }

        .hidden-counter {
            text-align: center;
            padding: 8px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 6px;
            margin-top: 8px;
            font-size: 12px;
            color: #666;
        }

        .info-box {
            position: absolute;
            top: 80px;
            right: 20px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 100;
            max-width: 320px;
            max-height: 400px;
            overflow-y: auto;
            border-left: 4px solid #16a34a;
        }

        .info-box h3 {
            margin: 0 0 12px 0;
            color: #001960;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            background: #dc2626;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: #b91c1c;
            transform: rotate(90deg);
        }

        .property-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .property-item {
            padding: 8px 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #ddd;
            word-break: break-word;
        }

        .property-item.important {
            background: linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);
            border-left-color: #f59e0b;
        }

        .property-key {
            color: #666;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .property-value {
            color: #1f2937;
            font-size: 13px;
        }

        .time-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(20, 20, 30, 0.9);
            color: white;
            padding: 14px 18px;
            border-radius: 10px;
            font-size: 13px;
            z-index: 90;
            min-width: 220px;
            border-left: 4px solid #16a34a;
            backdrop-filter: blur(10px);
        }

        .time-display {
            margin-bottom: 8px;
            font-weight: 600;
        }

        .time-display strong {
            color: #4ade80;
        }

        .time-info .time-row {
            margin: 6px 0;
            font-size: 15px;
            font-weight: 600;
        }

        .time-info .time-row.utc {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            font-weight: normal;
        }

        .status-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 16px 28px;
            border-radius: 10px;
            font-size: 15px;
            z-index: 200;
            animation: fadeInOut 3s ease-in-out forwards;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }

        .footer {
            position: absolute;
            bottom: 8px;
            right: 12px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.8);
            background: rgba(0, 0, 0, 0.5);
            padding: 4px 10px;
            border-radius: 4px;
            z-index: 10;
        }

        .footer a {
            color: #60a5fa;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        /* Hide Cesium default UI */
        .cesium-viewer-bottom,
        .cesium-credit-logoContainer,
        .cesium-credit-expand-link {
            display: none !important;
        }

        /* Scrollbar */
        .control-panel::-webkit-scrollbar,
        .info-box::-webkit-scrollbar {
            width: 6px;
        }

        .control-panel::-webkit-scrollbar-track,
        .info-box::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
        }

        .control-panel::-webkit-scrollbar-thumb,
        .info-box::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        @media (max-width: 768px) {
            .header {
                padding: 0 12px;
                height: 50px;
            }

            .header-title {
                font-size: 16px;
            }

            .header-subtitle {
                display: none;
            }

            .nav-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .control-panel {
                top: 60px;
                left: 10px;
                min-width: 180px;
                padding: 12px;
            }

            .info-box {
                top: auto;
                bottom: 100px;
                right: 10px;
                left: 10px;
                max-width: none;
            }

            .time-info {
                bottom: 10px;
                left: 10px;
                min-width: 180px;
                padding: 10px 14px;
            }
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    
    <div class="header">
        <div class="header-content">
            <div class="header-title">
                <span>üåç</span>
                <span>3D City Map</span>
            </div>
            <div class="header-subtitle">Shadow Simulation & Urban Analysis</div>
        </div>
        <div class="header-nav">
            <button class="nav-btn" onclick="openHelp()">‚ùì Help</button>
            <button class="nav-btn" onclick="openAbout()">‚ÑπÔ∏è About</button>
        </div>
    </div>

    <div class="control-panel" id="controlPanel"></div>
    <div class="time-info" id="timeInfo"></div>
    <div class="footer">
        Powered by <a href="https://cesium.com" target="_blank">Cesium</a> | 3D Geospatial Visualization
    </div>

    <script>
        // ==================== CESIUM CONFIGURATION ====================
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI3ZTQyMjc5My0wNWMxLTQwYjItYTQ2Ny1hN2NmMWQzZTU1ODgiLCJpZCI6Mzc5Njc4LCJpYXQiOjE3Njg1NjY1ODJ9.uNoYxXVWAb2rKHk2u5Etox_rRfq7IUnCFsAK_424OiQ';

        const MODEL_ASSET_ID_1 = 4392344;
        const MODEL_ASSET_ID_2 = 4392629;
        const OSM_BUILDINGS_ASSET_ID = 96188;
        
        let viewer;
        let modelPrimitive1 = null;
        let modelPrimitive2 = null;
        let model1Visible = true;
        let model2Visible = true;
        let osmBuildingsPrimitive = null;
        let osmBuildingsVisible = false;
        let selectedEntity = null;
        let currentTime = Cesium.JulianDate.now();
        let hiddenElements = new Map();
        let selectedElementForHiding = null;

        // ==================== INITIALIZATION ====================
        async function initializeViewer() {
            try {
                showStatusMessage('Initializing 3D viewer...');

                viewer = new Cesium.Viewer('cesiumContainer', {
                    terrain: Cesium.Terrain.fromWorldTerrain({
                        requestWaterMask: true,
                        requestVertexNormals: true
                    }),
                    shadows: true,
                    shouldAnimate: true,
                    animation: false,
                    timeline: false,
                    baseLayerPicker: false,
                    geocoder: false,
                    homeButton: false,
                    sceneModePicker: false,
                    navigationHelpButton: false,
                    fullscreenButton: false,
                    infoBox: false,
                    selectionIndicator: false
                });

                viewer.scene.shadowMap.enabled = true;
                viewer.scene.shadowMap.softShadows = true;
                viewer.scene.shadowMap.darkness = 0.5;
                viewer.scene.globe.enableLighting = true;
                viewer.scene.lightSource = new Cesium.DirectionalLight({
                    direction: new Cesium.Cartesian3(0.1, 0.2, 1)
                });

                await loadModels();
                setupControlPanel();
                setupPickHandler();
                updateTimeDisplay();

                console.log('Initialization complete');
            } catch (error) {
                console.error('Initialization error:', error);
                showStatusMessage('Error: ' + error.message);
            }
        }

        // ==================== MODEL LOADING ====================
        async function loadModels() {
            try {
                showStatusMessage('Loading 3D models...');

                const [tileset1, tileset2] = await Promise.all([
                    Cesium.Cesium3DTileset.fromIonAssetId(MODEL_ASSET_ID_1, { maximumScreenSpaceError: 16 }),
                    Cesium.Cesium3DTileset.fromIonAssetId(MODEL_ASSET_ID_2, { maximumScreenSpaceError: 16 })
                ]);

                modelPrimitive1 = viewer.scene.primitives.add(tileset1);
                modelPrimitive2 = viewer.scene.primitives.add(tileset2);

                await new Promise(resolve => setTimeout(resolve, 500));
                await viewer.zoomTo(modelPrimitive1, new Cesium.HeadingPitchRange(0, -Math.PI / 6, 0));

                showStatusMessage('Models loaded successfully!');
            } catch (error) {
                console.error('Model loading error:', error);
                showStatusMessage('Models loaded (some features limited)');
            }
        }

        // ==================== PICK HANDLER ====================
        function setupPickHandler() {
            viewer.canvas.addEventListener('click', function(e) {
                const pickedObject = viewer.scene.pick(new Cesium.Cartesian2(e.clientX, e.clientY));

                if (Cesium.defined(pickedObject) && pickedObject.id) {
                    displayElementInfo(pickedObject.id);
                } else {
                    if (selectedEntity) {
                        selectedEntity.color = undefined;
                        selectedEntity = null;
                    }
                    closeInfoBox();
                }
            });
        }

        // ==================== ELEMENT INFO ====================
        function displayElementInfo(entity) {
            selectedEntity = entity;
            selectedElementForHiding = entity;

            if (entity.color !== undefined) {
                entity.color = Cesium.Color.YELLOW.withAlpha(0.7);
            }

            const properties = getEntityProperties(entity);
            renderInfoBox(properties);
        }

        function getEntityProperties(entity) {
            const props = {};

            if (entity.properties) {
                for (let key in entity.properties) {
                    if (entity.properties.hasOwnProperty(key)) {
                        const value = entity.properties[key];
                        props[key] = Cesium.defined(value) ? value.getValue(Cesium.JulianDate.now()) : 'N/A';
                    }
                }
            }

            ['id', 'name', 'description', 'categoryName', 'Family', 'Type', 'Level'].forEach(prop => {
                if (entity[prop] !== undefined && !props[prop]) {
                    props[prop] = entity[prop];
                }
            });

            return props;
        }

        function renderInfoBox(properties) {
            closeInfoBox();

            const infoBox = document.createElement('div');
            infoBox.className = 'info-box';
            infoBox.id = 'infoBox';

            const importantProps = ['categoryName', 'Family', 'Type', 'Level', 'name', 'id'];

            let html = '<h3>Element Properties <button class="close-btn" id="closeBtn">‚úï</button></h3>';
            html += '<div class="property-list">';

            for (let key in properties) {
                if (properties.hasOwnProperty(key)) {
                    const isImportant = importantProps.includes(key);
                    html += `
                        <div class="property-item ${isImportant ? 'important' : ''}">
                            <div class="property-key">${escapeHtml(key)}</div>
                            <div class="property-value">${escapeHtml(String(properties[key]))}</div>
                        </div>
                    `;
                }
            }

            html += '</div>';
            infoBox.innerHTML = html;
            document.body.appendChild(infoBox);

            document.getElementById('closeBtn').addEventListener('click', function(e) {
                e.stopPropagation();
                closeInfoBox();
                if (selectedEntity && selectedEntity.color !== undefined) {
                    selectedEntity.color = undefined;
                    selectedEntity = null;
                }
            });
        }

        function closeInfoBox() {
            const infoBox = document.getElementById('infoBox');
            if (infoBox) infoBox.remove();
        }

        // ==================== CONTROL PANEL ====================
        function setupControlPanel() {
            const panel = document.getElementById('controlPanel');

            let html = '<h3>‚òÄÔ∏è Shadow Simulation</h3>';
            html += '<div class="button-group">';
            html += '<button class="control-btn" id="setDateTimeBtn">üìÖ Set Date/Time</button>';
            html += '<button class="control-btn" id="resetCameraBtn">üé• Reset Camera</button>';
            html += '</div>';

            html += '<label class="section-label">Asset Visibility:</label>';
            html += '<div class="button-group">';
            html += '<button class="control-btn" id="model1Btn">üëÅÔ∏è Asset 1: ON</button>';
            html += '<button class="control-btn" id="model2Btn">üëÅÔ∏è Asset 2: ON</button>';
            html += '<button class="control-btn" id="osmBuildingsBtn">üè¢ OSM Buildings: OFF</button>';
            html += '</div>';

            html += '<label class="section-label">Element Visibility:</label>';
            html += '<div class="button-group">';
            html += '<button class="control-btn orange" id="hideSelectedBtn">üëÅÔ∏è Hide Selected</button>';
            html += '<button class="control-btn purple" id="showAllBtn">üëÅÔ∏è Show All Hidden</button>';
            html += '<div class="hidden-counter">Hidden elements: <span id="hiddenCount">0</span></div>';
            html += '</div>';

            html += '<label class="section-label">Quick Time Selection:</label>';
            html += '<select class="dropdown-menu" id="quickTimeSelect">';
            html += '<option value="">-- Select Time --</option>';
            html += '<option value="current">Current Time</option>';
            html += '<option value="08:00">Morning (08:00 CET)</option>';
            html += '<option value="12:00">Noon (12:00 CET)</option>';
            html += '<option value="15:00">Afternoon (15:00 CET)</option>';
            html += '<option value="18:00">Evening (18:00 CET)</option>';
            html += '</select>';

            panel.innerHTML = html;

            setTimeout(() => {
                document.getElementById('setDateTimeBtn')?.addEventListener('click', setDateTimePrompt);
                document.getElementById('resetCameraBtn')?.addEventListener('click', resetCamera);
                document.getElementById('model1Btn')?.addEventListener('click', toggleModel1);
                document.getElementById('model2Btn')?.addEventListener('click', toggleModel2);
                document.getElementById('osmBuildingsBtn')?.addEventListener('click', toggleOSMBuildings);
                document.getElementById('hideSelectedBtn')?.addEventListener('click', hideSelectedElement);
                document.getElementById('showAllBtn')?.addEventListener('click', showAllHiddenElements);
                document.getElementById('quickTimeSelect')?.addEventListener('change', function(e) {
                    if (e.target.value) {
                        handleQuickTimeSelect(e.target.value);
                        e.target.value = '';
                    }
                });
            }, 100);
        }

        // ==================== DATE/TIME CONTROL ====================
        function setDateTimePrompt() {
            const dateInput = prompt('Enter date (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
            if (!dateInput) return;

            if (!/^\d{4}-\d{2}-\d{2}$/.test(dateInput)) {
                showStatusMessage('Invalid date format. Use YYYY-MM-DD');
                return;
            }

            const timeInput = prompt('Enter time in CET (HH:MM):', '12:00');
            if (!timeInput) return;

            if (!/^\d{2}:\d{2}$/.test(timeInput)) {
                showStatusMessage('Invalid time format. Use HH:MM');
                return;
            }

            setDateTimeFromInput(dateInput, timeInput);
        }

        function setDateTimeFromInput(dateString, timeString) {
            try {
                const [year, month, day] = dateString.split('-').map(Number);
                const [hours, minutes] = timeString.split(':').map(Number);
                const date = new Date(year, month - 1, day, hours, minutes, 0);
                const cetOffset = getCETOffset(date);
                const utcDate = new Date(date.getTime() - cetOffset * 60000);

                currentTime = Cesium.JulianDate.fromDate(utcDate);
                viewer.clock.currentTime = currentTime;

                updateShadowDirection();
                updateTimeDisplay();
                showStatusMessage(`Time set to: ${dateString} ${timeString} CET`);
            } catch (error) {
                showStatusMessage('Error parsing date/time');
            }
        }

        function handleQuickTimeSelect(value) {
            if (value === 'current') {
                currentTime = Cesium.JulianDate.now();
            } else {
                const cesiumDate = Cesium.JulianDate.toDate(currentTime);
                const [hours, minutes] = value.split(':').map(Number);
                const date = new Date(cesiumDate.getFullYear(), cesiumDate.getMonth(), cesiumDate.getDate(), hours, minutes, 0);
                const cetOffset = getCETOffset(date);
                const utcDate = new Date(date.getTime() - cetOffset * 60000);
                currentTime = Cesium.JulianDate.fromDate(utcDate);
            }

            viewer.clock.currentTime = currentTime;
            updateShadowDirection();
            updateTimeDisplay();
        }

        // ==================== SHADOW CALCULATION ====================
        function updateShadowDirection() {
            const date = Cesium.JulianDate.toDate(currentTime);
            const sunPosition = calculateSunPosition(date);
            if (viewer.scene.lightSource) {
                viewer.scene.lightSource.direction = sunPosition;
            }
        }

        function calculateSunPosition(date) {
            const dayOfYear = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / 86400000);
            const hourOfDay = date.getHours() + date.getMinutes() / 60;
            const declination = 23.44 * Math.sin((dayOfYear - 81) * Math.PI / 182.6) * Math.PI / 180;
            const hourAngle = (hourOfDay - 12) * 15 * Math.PI / 180;
            const x = Math.cos(declination) * Math.sin(hourAngle);
            const y = Math.sin(declination);
            const z = Math.cos(declination) * Math.cos(hourAngle);
            return new Cesium.Cartesian3(x, y, z);
        }

        // ==================== TIME CONVERSION ====================
        function getCETOffset(date) {
            const year = date.getFullYear();
            const lastSundayMarch = getLastSunday(year, 2);
            const lastSundayOctober = getLastSunday(year, 9);
            return (date >= lastSundayMarch && date < lastSundayOctober) ? -120 : -60;
        }

        function getLastSunday(year, month) {
            const date = new Date(year, month + 1, 0);
            while (date.getDay() !== 0) date.setDate(date.getDate() - 1);
            return date;
        }

        // ==================== DISPLAY UPDATES ====================
        function updateTimeDisplay() {
            const dateUtc = Cesium.JulianDate.toDate(currentTime);
            const cetOffset = getCETOffset(dateUtc);
            const cetDate = new Date(dateUtc.getTime() + cetOffset * 60000);

            const timeInfo = document.getElementById('timeInfo');
            if (!timeInfo) return;

            const dateStr = cetDate.toLocaleDateString('en-CA');
            const timeCET = cetDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
            const timeUTC = dateUtc.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });

            timeInfo.innerHTML = `
                <div class="time-display"><strong>Current Time:</strong></div>
                <div class="time-row">${dateStr}</div>
                <div class="time-row" style="color: #4ade80;">${timeCET} CET</div>
                <div class="time-row utc">${timeUTC} UTC</div>
            `;
        }

        function resetCamera() {
            if (modelPrimitive1) {
                viewer.zoomTo(modelPrimitive1, new Cesium.HeadingPitchRange(0, -Math.PI / 6, 0));
                showStatusMessage('Camera reset');
            }
        }

        // ==================== ASSET TOGGLES ====================
        function toggleModel1() {
            if (!modelPrimitive1) {
                showStatusMessage('Asset 1 not loaded');
                return;
            }
            model1Visible = !model1Visible;
            modelPrimitive1.show = model1Visible;
            document.getElementById('model1Btn').textContent = `üëÅÔ∏è Asset 1: ${model1Visible ? 'ON' : 'OFF'}`;
            showStatusMessage(`Asset 1 ${model1Visible ? 'enabled' : 'disabled'}`);
        }

        function toggleModel2() {
            if (!modelPrimitive2) {
                showStatusMessage('Asset 2 not loaded');
                return;
            }
            model2Visible = !model2Visible;
            modelPrimitive2.show = model2Visible;
            document.getElementById('model2Btn').textContent = `üëÅÔ∏è Asset 2: ${model2Visible ? 'ON' : 'OFF'}`;
            showStatusMessage(`Asset 2 ${model2Visible ? 'enabled' : 'disabled'}`);
        }

        async function toggleOSMBuildings() {
            try {
                if (osmBuildingsVisible) {
                    if (osmBuildingsPrimitive) {
                        viewer.scene.primitives.remove(osmBuildingsPrimitive);
                        osmBuildingsPrimitive = null;
                    }
                    osmBuildingsVisible = false;
                    document.getElementById('osmBuildingsBtn').textContent = 'üè¢ OSM Buildings: OFF';
                    showStatusMessage('OSM Buildings disabled');
                } else {
                    const tileset = await Cesium.Cesium3DTileset.fromIonAssetId(OSM_BUILDINGS_ASSET_ID, {
                        maximumScreenSpaceError: 8
                    });
                    osmBuildingsPrimitive = viewer.scene.primitives.add(tileset);
                    osmBuildingsVisible = true;
                    document.getElementById('osmBuildingsBtn').textContent = 'üè¢ OSM Buildings: ON';
                    showStatusMessage('OSM Buildings enabled');
                }
            } catch (error) {
                showStatusMessage('Error loading OSM Buildings');
            }
        }

        // ==================== ELEMENT VISIBILITY ====================
        function hideSelectedElement() {
            if (!selectedElementForHiding) {
                showStatusMessage('No element selected');
                return;
            }

            if (!hiddenElements.has(selectedElementForHiding)) {
                hiddenElements.set(selectedElementForHiding, {
                    originalColor: selectedElementForHiding.color,
                    originalShow: selectedElementForHiding.show
                });
            }

            selectedElementForHiding.show = false;
            updateHiddenCounter();
            showStatusMessage(`Element hidden (${hiddenElements.size} hidden)`);
            selectedElementForHiding = null;
            closeInfoBox();
        }

        function showAllHiddenElements() {
            if (hiddenElements.size === 0) {
                showStatusMessage('No hidden elements');
                return;
            }

            hiddenElements.forEach((state, element) => {
                element.show = true;
                element.color = state.originalColor;
            });

            hiddenElements.clear();
            updateHiddenCounter();
            showStatusMessage('All elements visible!');
        }

        function updateHiddenCounter() {
            const counter = document.getElementById('hiddenCount');
            if (counter) counter.textContent = hiddenElements.size;
        }

        // ==================== UTILITY ====================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showStatusMessage(message) {
            const statusDiv = document.createElement('div');
            statusDiv.className = 'status-message';
            statusDiv.textContent = message;
            document.body.appendChild(statusDiv);
            setTimeout(() => statusDiv.remove(), 3000);
        }

        function openHelp() {
            alert(`üìñ Quick Start Guide

1. DATE/TIME CONTROL:
   ‚Ä¢ Click "Set Date/Time" for custom date/time (CET)
   ‚Ä¢ Use Quick Selection for preset times
   ‚Ä¢ Shadows update automatically

2. ASSET VISIBILITY:
   ‚Ä¢ Toggle Asset 1 & 2 independently
   ‚Ä¢ Enable/disable OSM buildings for context

3. ELEMENT SELECTION:
   ‚Ä¢ Click any 3D element to select
   ‚Ä¢ Properties appear on the right
   ‚Ä¢ Click "Hide Selected" to hide elements

4. NAVIGATION:
   ‚Ä¢ Left-click drag to rotate
   ‚Ä¢ Right-click drag to pan
   ‚Ä¢ Scroll to zoom`);
        }

        function openAbout() {
            alert(`üåç 3D City Map - Shadow Simulation

Features:
‚Ä¢ Dual asset visualization
‚Ä¢ CET/CEST time control
‚Ä¢ Real-time shadow simulation
‚Ä¢ OSM buildings context layer
‚Ä¢ Element visibility control
‚Ä¢ Interactive property inspection

Built with Cesium.js`);
        }

        // ==================== AUTO-UPDATE & START ====================
        setInterval(updateTimeDisplay, 1000);
        initializeViewer();
    </script>
</body>
</html>
