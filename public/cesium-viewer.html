<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Site Viewer - Professional</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.104/Cesium.js" crossorigin="anonymous"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.104/Widgets/widgets.css" rel="stylesheet" crossorigin="anonymous">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
        }

        #cesiumContainer {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

    </style>
</head>
<body>
    <div id="cesiumContainer"></div>

    <script>
// Check if Cesium loaded from CDN
if (typeof Cesium === 'undefined') {
    document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;background:#0f172a;color:#ff6b6b;font-family:sans-serif;flex-direction:column;gap:16px;"><h2>Failed to load Cesium.js</h2><p style="color:#94a3b8;">The 3D engine could not be loaded. Check your internet connection.</p><button onclick="location.reload()" style="padding:10px 24px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer;">Retry</button></div>';
    throw new Error('Cesium.js CDN failed to load');
}

try {
// 1. INJECT PROFESSIONAL TOP-BAR CSS STYLES
const styles = `
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@500&display=swap');

    body { 
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
        overflow: hidden; 
        background: #0f172a; /* Slate 900 */
        margin: 0;
        user-select: none;
    }
    
    /* Hide default Cesium UI */
    .cesium-viewer-toolbar, .cesium-viewer-animationContainer, 
    .cesium-viewer-timelineContainer, .cesium-viewer-bottom, 
    .cesium-viewer-fullscreenContainer, .cesium-selection-wrapper { display: none !important; }

    /* ================= TOP BAR CONTAINER ================= */
    .top-bar {
        position: absolute; top: 0; left: 0; width: 100%; height: 64px;
        background: rgba(15, 23, 42, 0.95); /* Deep Slate */
        backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        z-index: 100; 
        color: #f8fafc;
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 24px;
        box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.3);
    }
    
    /* Branding Area */
    .branding {
        display: flex; align-items: center; gap: 14px;
        border-right: 1px solid rgba(255,255,255,0.1);
        padding-right: 24px;
        margin-right: 24px;
        height: 40px;
    }
    .branding-icon {
        width: 42px; height: 42px; 
        color: #ffffff; 
        display: flex; align-items: center; justify-content: center;
    }
    .branding-icon svg { width: 100%; height: 100%; }

    .branding-text h1 { font-size: 18px; font-weight: 700; margin: 0; color: white; letter-spacing: -0.02em; }

    /* ================= TOOLBAR GROUPS ================= */
    .toolbar-group { display: flex; align-items: center; gap: 16px; height: 100%; }
    .toolbar-divider { width: 1px; height: 24px; background: rgba(255,255,255,0.1); margin: 0 8px; }
    .group-label { font-size: 10px; font-weight: 600; color: #64748b; text-transform: uppercase; margin-right: 4px; }

    /* ================= LAYER TOGGLES ================= */
    .layer-toggles { display: flex; gap: 8px; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 8px; }
    
    .layer-btn {
        display: flex; align-items: center; gap: 8px;
        padding: 6px 12px;
        border-radius: 6px; cursor: pointer;
        background: transparent;
        border: 1px solid transparent;
        color: #94a3b8;
        font-size: 12px; font-weight: 500;
        transition: all 0.2s ease;
    }
    .layer-btn:hover { background: rgba(255,255,255,0.05); color: white; }
    
    .layer-btn.active { background: rgba(59, 130, 246, 0.15); color: #60a5fa; border-color: rgba(59, 130, 246, 0.3); }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; background: #475569; }
    .layer-btn.active .status-dot { background: #34d399; box-shadow: 0 0 6px rgba(52, 211, 153, 0.4); }

    .layer-btn.point-cloud.active { background: rgba(168, 85, 247, 0.15); color: #c084fc; border-color: rgba(168, 85, 247, 0.3); }
    .layer-btn.point-cloud.active .status-dot { background: #c084fc; box-shadow: 0 0 6px rgba(192, 132, 252, 0.4); }

    /* ================= MEASURE BUTTONS ================= */
    .tool-btn {
        display: flex; align-items: center; gap: 6px;
        padding: 6px 12px; border-radius: 6px; cursor: pointer;
        background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
        color: #cbd5e1; font-size: 12px; font-weight: 500; transition: all 0.2s;
    }
    .tool-btn:hover { background: rgba(255,255,255,0.1); color: white; border-color: rgba(255,255,255,0.2); }
    .tool-btn.active { background: #f59e0b; color: #fff; border-color: #f59e0b; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4); }

    /* ================= TIME SLIDER ================= */
    .time-slider-container { display: flex; align-items: center; gap: 10px; }
    
    .time-slider {
        -webkit-appearance: none;
        width: 140px;
        height: 4px;
        background: rgba(255,255,255,0.1);
        border-radius: 2px;
        outline: none;
    }
    
    .time-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #3b82f6;
        cursor: pointer;
        border: 2px solid #0f172a;
        box-shadow: 0 0 0 1px #3b82f6;
        transition: transform 0.1s;
    }
    
    .time-slider::-webkit-slider-thumb:hover { transform: scale(1.1); }
    
    .slider-value {
        font-family: 'JetBrains Mono', monospace;
        font-size: 12px;
        color: #3b82f6;
        font-weight: 600;
        min-width: 45px;
    }

    /* ================= ACTION BUTTONS ================= */
    .icon-btn {
        width: 36px; height: 36px; border-radius: 6px;
        display: flex; align-items: center; justify-content: center;
        background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
        color: #cbd5e1; cursor: pointer; transition: all 0.2s; font-size: 14px;
    }
    .icon-btn:hover { background: rgba(255,255,255,0.1); color: white; }
    .icon-btn.primary { background: #3b82f6; color: white; border: none; width: auto; padding: 0 16px; font-size: 12px; font-weight: 500; }
    .icon-btn.primary:hover { background: #2563eb; }

    /* ================= INFO BOX ================= */
    .info-box {
        position: absolute; top: 80px; right: 24px; width: 300px;
        background: rgba(15, 23, 42, 0.98); border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.15); 
        box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        z-index: 100; color: #f1f5f9; overflow: hidden;
    }
    .info-box-header { 
        padding: 12px 16px; background: rgba(30, 41, 59, 0.5);
        border-bottom: 1px solid rgba(148, 163, 184, 0.1); 
        display: flex; justify-content: space-between; align-items: center;
    }
    .info-box-header h3 { font-size: 12px; margin: 0; font-weight: 600; color: white; text-transform: uppercase; letter-spacing: 0.5px;}
    .info-box-body { padding: 12px 16px; max-height: 400px; overflow-y: auto; }
    .prop-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 12px; }
    .prop-key { color: #64748b; font-weight: 500; }
    .prop-value { color: #e2e8f0; font-family: 'JetBrains Mono', monospace; }

    /* ================= BOTTOM STATUS BAR ================= */
    .bottom-bar {
        position: absolute; bottom: 0; left: 0; width: 100%; height: 32px;
        background: rgba(15, 23, 42, 0.95); border-top: 1px solid rgba(255,255,255,0.1);
        display: flex; align-items: center; justify-content: space-between; padding: 0 24px;
        font-size: 11px; color: #64748b; z-index: 90;
    }
    .clock-display { font-family: 'JetBrains Mono', monospace; color: #34d399; font-weight: 600; display: flex; align-items: center; gap: 8px;}
    .status-indicator { width: 6px; height: 6px; background: #34d399; border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    /* Toast */
    .status-toast {
        position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%);
        background: #1e293b; padding: 8px 20px; border-radius: 50px;
        color: white; z-index: 200; pointer-events: none;
        border: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-size: 12px; font-weight: 500;
    }
`;

const styleSheet = document.createElement("style");
styleSheet.innerText = styles;
document.head.appendChild(styleSheet);

// 2. INJECT HTML TOP-BAR UI
const uiHTML = `
    <div class="top-bar">
        <div class="toolbar-group">
            <div class="branding">
                <div class="branding-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="4" y="4" width="4" height="16" rx="2" fill="white"/>
                        <path d="M16 4L22 8V16L16 20L10 16V8L16 4Z" fill="white"/>
                    </svg>
                </div>
                <div class="branding-text">
                    <h1>Site Viewer</h1>
                </div>
            </div>

            <div class="layer-toggles">
                <button class="layer-btn active" id="btnLayer1" onclick="toggleLayer('1')">
                    <div class="status-dot"></div> Main Structure
                </button>
                <button class="layer-btn point-cloud active" id="btnLayer2" onclick="toggleLayer('2')">
                    <div class="status-dot"></div> <span style="font-family:serif; font-weight:bold; font-size:14px;">‚Åñ</span> Point Cloud
                </button>
                <button class="layer-btn" id="btnLayerOSM" onclick="toggleLayer('OSM')">
                    <div class="status-dot"></div> Context
                </button>
            </div>
        </div>

        <div class="toolbar-group">
            
            <div class="toolbar-group">
                <span class="group-label">Analysis:</span>
                <button class="tool-btn" id="measureBtn" onclick="toggleMeasureMode()">
                    <span>üìè</span> Distance
                </button>
                 <button class="tool-btn" onclick="clearMeasurements()" style="border-style:dashed; opacity:0.7;">
                    <span>üóëÔ∏è</span> Clear
                </button>
            </div>

            <div class="toolbar-divider"></div>

            <div class="toolbar-group">
                <span class="group-label">Shadows:</span>
                <div class="time-slider-container">
                    <input type="range" min="6" max="20" step="0.1" value="12" class="time-slider" oninput="handleSliderInput(this.value)">
                    <span id="sliderTimeLabel" class="slider-value">12:00</span>
                </div>
            </div>

            <div class="toolbar-divider"></div>

            <div class="toolbar-group">
                <button class="icon-btn" id="hideSelectedBtn" title="Hide Selected Object">üëÅÔ∏è‚Äçüó®Ô∏è</button>
                <button class="icon-btn" id="showAllBtn" title="Restore Visibility">‚Ü∫</button>
                <button class="icon-btn primary" id="resetCameraBtn">Recenter</button>
            </div>
        </div>
    </div>

    <div class="bottom-bar">
        <div>System Status: <span style="color:#cbd5e1">Operational</span> <span id="measureStatus" style="color:#f59e0b; margin-left:15px; display:none;">‚Ä¢ MEASURE MODE ACTIVE</span></div>
        <div class="clock-display">
            <div class="status-indicator"></div>
            <span id="timeDateDisplay">--</span> | <span id="timeClockDisplay">--:--</span> CET
        </div>
    </div>
`;

const uiContainer = document.createElement("div");
uiContainer.innerHTML = uiHTML;
document.body.appendChild(uiContainer);

// 3. JAVASCRIPT LOGIC (CESIUM)
Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI3ZTQyMjc5My0wNWMxLTQwYjItYTQ2Ny1hN2NmMWQzZTU1ODgiLCJpZCI6Mzc5Njc4LCJpYXQiOjE3Njg1NjY1ODJ9.uNoYxXVWAb2rKHk2u5Etox_rRfq7IUnCFsAK_424OiQ";

const MODEL_ASSET_ID_1 = "4392344";
const MODEL_ASSET_ID_2 = "4392629"; 
const OSM_BUILDINGS_ASSET_ID = "96188";

const viewer = new Cesium.Viewer("cesiumContainer", {
    terrain: Cesium.Terrain.fromWorldTerrain(),
    shadows: true,
    shouldAnimate: true,
    timeline: false,
    animation: false,
    baseLayerPicker: false,
    homeButton: false,
    navigationHelpButton: false,
    sceneModePicker: false,
    geocoder: false,
    fullscreenButton: false,
    selectionIndicator: false,
    infoBox: false
});

viewer.scene.shadowMap.enabled = true;
viewer.scene.shadowMap.softShadows = true;
viewer.scene.globe.enableLighting = true;

// GLOBAL STATE
let modelPrimitive1, modelPrimitive2, osmBuildingsPrimitive;
let hiddenElements = new Map();
let selectedElement = null;
let measureMode = false;
let measurePoints = [];
let measureEntities = [];

// ================= INITIALIZATION =================
async function loadModels() {
    try {
        const t1 = await Cesium.Cesium3DTileset.fromIonAssetId(MODEL_ASSET_ID_1);
        modelPrimitive1 = viewer.scene.primitives.add(t1);
        
        const t2 = await Cesium.Cesium3DTileset.fromIonAssetId(MODEL_ASSET_ID_2);
        modelPrimitive2 = viewer.scene.primitives.add(t2);
        
        await viewer.zoomTo(modelPrimitive1, new Cesium.HeadingPitchRange(0, -0.5, 500));
        showToast("System Ready - Models Loaded");
    } catch(e) { console.log(e); }
}

// ================= LAYERS =================
window.toggleLayer = async (layerId) => {
    const btn = document.getElementById('btnLayer' + layerId);
    const isActive = btn.classList.contains('active');
    
    if(isActive) btn.classList.remove('active');
    else btn.classList.add('active');

    if(layerId === '1' && modelPrimitive1) modelPrimitive1.show = !isActive;
    if(layerId === '2' && modelPrimitive2) modelPrimitive2.show = !isActive;
    
    if(layerId === 'OSM') {
        if(!isActive) { 
            if(!osmBuildingsPrimitive) {
                showToast("Loading City Context...");
                osmBuildingsPrimitive = viewer.scene.primitives.add(await Cesium.Cesium3DTileset.fromIonAssetId(OSM_BUILDINGS_ASSET_ID));
            }
            osmBuildingsPrimitive.show = true;
        } else {
            if(osmBuildingsPrimitive) osmBuildingsPrimitive.show = false;
        }
    }
};

// ================= SHADOW SLIDER LOGIC =================
window.handleSliderInput = (val) => {
    // 1. Calculate Time from slider value (float hours)
    const hours = Math.floor(val);
    const minutes = Math.floor((val - hours) * 60);
    
    const date = new Date();
    date.setHours(hours, minutes, 0);
    
    // 2. Update UI Label
    const timeStr = `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}`;
    document.getElementById('sliderTimeLabel').innerText = timeStr;

    // 3. Update Cesium Sun Position
    // Rough simulation: UTC = Local Time - 1 Hour
    const utcDate = new Date(date.getTime() - (60 * 60 * 1000)); 
    viewer.clock.currentTime = Cesium.JulianDate.fromDate(utcDate);
    updateTimeDisplay();
}

// ================= MEASUREMENT TOOLS =================
window.toggleMeasureMode = () => {
    measureMode = !measureMode;
    const btn = document.getElementById('measureBtn');
    const status = document.getElementById('measureStatus');
    
    if(measureMode) {
        btn.classList.add('active');
        status.style.display = "inline";
        viewer.canvas.style.cursor = "crosshair";
        showToast("Measure Mode: Click 2 points");
        closeInfoBox();
    } else {
        btn.classList.remove('active');
        status.style.display = "none";
        viewer.canvas.style.cursor = "default";
        measurePoints = [];
    }
};

window.clearMeasurements = () => {
    measureEntities.forEach(e => viewer.entities.remove(e));
    measureEntities = [];
    measurePoints = [];
    showToast("Measurements Cleared");
};

// ================= INTERACTION HANDLER =================
const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);

handler.setInputAction((click) => {
    // 1. MEASUREMENT LOGIC
    if (measureMode) {
        const pickedPosition = viewer.scene.pickPosition(click.position);
        if (pickedPosition) {
            measurePoints.push(pickedPosition);
            
            // Draw Point
            const pointEntity = viewer.entities.add({
                position: pickedPosition,
                point: { pixelSize: 8, color: Cesium.Color.YELLOW, disableDepthTestDistance: Number.POSITIVE_INFINITY }
            });
            measureEntities.push(pointEntity);

            // If we have 2 points, draw line and label
            if (measurePoints.length === 2) {
                const start = measurePoints[0];
                const end = measurePoints[1];
                const distance = Cesium.Cartesian3.distance(start, end);
                
                // Draw Line
                const lineEntity = viewer.entities.add({
                    polyline: {
                        positions: [start, end],
                        width: 3,
                        material: new Cesium.PolylineDashMaterialProperty({ color: Cesium.Color.YELLOW }),
                        depthFailMaterial: new Cesium.PolylineDashMaterialProperty({ color: Cesium.Color.YELLOW })
                    }
                });
                measureEntities.push(lineEntity);

                // Draw Label at midpoint
                const midpoint = Cesium.Cartesian3.lerp(start, end, 0.5, new Cesium.Cartesian3());
                const labelEntity = viewer.entities.add({
                    position: midpoint,
                    label: {
                        text: `${distance.toFixed(2)}m`,
                        font: '14px JetBrains Mono',
                        fillColor: Cesium.Color.BLACK,
                        showBackground: true,
                        backgroundColor: Cesium.Color.YELLOW,
                        backgroundPadding: new Cesium.Cartesian2(8, 4),
                        disableDepthTestDistance: Number.POSITIVE_INFINITY,
                        pixelOffset: new Cesium.Cartesian2(0, -20)
                    }
                });
                measureEntities.push(labelEntity);

                // Reset for next pair
                measurePoints = []; 
                showToast(`Distance: ${distance.toFixed(2)}m`);
            }
        }
        return; // Stop processing picks if measuring
    }

    // 2. STANDARD SELECTION LOGIC
    const picked = viewer.scene.pick(click.position);
    if (Cesium.defined(picked)) {
        selectedElement = picked;
        if (picked instanceof Cesium.Cesium3DTileFeature) {
             picked.color = Cesium.Color.fromCssColorString('#3b82f6');
             showInfoBox(picked);
        }
    } else {
        selectedElement = null;
        closeInfoBox();
    }
}, Cesium.ScreenSpaceEventType.LEFT_CLICK);


// ================= ACTIONS =================
document.getElementById("hideSelectedBtn").onclick = () => {
    if (selectedElement) {
        hiddenElements.set(selectedElement, selectedElement.show);
        selectedElement.show = false;
        selectedElement.color = Cesium.Color.TRANSPARENT; 
        selectedElement = null;
        closeInfoBox();
        showToast("Object Hidden");
    } else {
        showToast("Select an object to hide");
    }
};

document.getElementById("showAllBtn").onclick = () => {
    hiddenElements.forEach((val, el) => {
        el.color = Cesium.Color.WHITE; 
        el.show = true;
    });
    hiddenElements.clear();
    showToast("Visibility Restored");
};

document.getElementById("resetCameraBtn").onclick = () => {
    if(modelPrimitive1) viewer.zoomTo(modelPrimitive1, new Cesium.HeadingPitchRange(0, -0.5, 500));
};

// ================= UI HELPERS =================
function updateTimeDisplay() {
    const d = Cesium.JulianDate.toDate(viewer.clock.currentTime);
    const local = new Date(d.getTime() + (60*60*1000));
    document.getElementById("timeClockDisplay").innerText = local.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    document.getElementById("timeDateDisplay").innerText = local.toLocaleDateString();
}

function showInfoBox(feature) {
    closeInfoBox();
    const props = feature.getPropertyNames();
    let content = `<div class="info-box" id="activeInfoBox">
        <div class="info-box-header"><h3>Properties</h3><button style="background:none; border:none; color:white; cursor:pointer;" onclick="closeInfoBox()">‚úï</button></div>
        <div class="info-box-body">`;
    
    const whitelist = ['name', 'id', 'Height', 'Level', 'Category', 'Family', 'Type'];
    let count = 0;
    props.forEach(p => { 
        if(count < 8 && (whitelist.includes(p) || p.length < 15)) {
             content += `<div class="prop-row"><span class="prop-key">${p}</span><span class="prop-value">${feature.getProperty(p)}</span></div>`;
             count++;
        }
    });
    content += `</div></div>`;
    
    const div = document.createElement("div");
    div.innerHTML = content;
    document.body.appendChild(div);
}

window.closeInfoBox = () => {
    const el = document.getElementById("activeInfoBox");
    if(el) el.remove();
};

function showToast(msg) {
    const t = document.createElement("div");
    t.className = "status-toast";
    t.innerText = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 2500);
}

// Start
loadModels();
setInterval(updateTimeDisplay, 1000);

} catch(err) {
    console.error('Cesium Viewer initialization failed:', err);
    document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;background:#0f172a;color:#ff6b6b;font-family:sans-serif;flex-direction:column;gap:16px;"><h2>Viewer Error</h2><p style="color:#94a3b8;max-width:400px;text-align:center;">' + err.message + '</p><button onclick="location.reload()" style="padding:10px 24px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer;">Retry</button></div>';
}
    </script>
</body>
</html>
